---
title: ''
author: ''
params:
  IPCC_model: RCP26
  key: 8
  vSeason: Annual
  yendP1: 1982
  yendP2: 2013
  yendP3: 2044
  ystartP1: 1952
  ystartP2: 1983
  ystartP3: 2014
output:
  pdf_document: default
  html_document:
    css: styleltar.css
  html_notebook:
    css: styleltar.css
  always_allow_html: default
  word_document: default
---
```{r setup, include=FALSE}
#----------------------------------------------------------------------------------------#
# NOTE: To work with R-notebook features you need to update RSTUDIO to version 1.0.44

# R-Version used in this R-notebook is Microsoft R-Open 3.3.1. You can download it from:
# For Mac: https://mran.microsoft.com/install/mro/3.3.1/microsoft-r-open-3.3.1.pkg 
# For Windows: https://mran.microsoft.com/install/mro/3.3.1/microsoft-r-open-3.3.1.msi
# For Unix: https://mran.microsoft.com/install/mro/3.3.1/microsoft-r-open-3.3.1.tar.gz


# Libraries section
# In case you don't have some of these libraries you can use github repositories to install the latest versions

# devtools::install_github('hadley/scales')
# devtools::install_github('tidyverse/tibble') 
# devtools::install_github("daattali/colourpicker")
# devtools::install_github("krlmlr/plogr")
# devtools::install_github("rstats-db/DBI")
# devtools::install_github("hadley/dplyr")
# devtools::install_github("edzer/hexbin")
# devtools::install_github('yihui/knitr')
# devtools::install_github('rstudio/leaflet')
# devtools::install_github("hadley/purrr")
# devtools::install_github('jbkunst/highcharter')
# devtools::install_github('ropensci/plotly')
# devtools::install_github('hadley/ggplot2')
# devtools::install_github('rstudio/flexdashboard')
# devtools::install_github('rstudio/rmarkdown')
# devtools::install_github('ramnathv/htmlwidgets')
# devtools::install_github('rstudio/shiny')
# install.packages("data.table")  # For data.table is ok to install the CRAN version

# debuggin the installation of plotly
source("http://bioconductor.org/biocLite.R") 
biocLite("hexbin")

# For this notebook we are using these libraries.  However, some of these might have some dependencies that can be installed using the github repositories (above)

library(data.table)
library(plyr)
library(dplyr)
library(ggplot2) 
library(plotly)
library(leaflet)


#################################### DOWNLOAD DATA FILE ####################################### 
# Uncomment the three lines below for downloading and unzipping data file. Once you have the 
# data get these lines commented again.
###############################################################################################

url <- "https://ftp.arsnet.usda.gov/Fileshare/PublicShare/FileDownload.ashx?value=cZFvyljrYfnz+Ju7zgMKNM8EihpnDBHZgtd89HTbbfesp6/Lg9i3kQ=="
download.file(url, "data_wgew.zip")
unzip ("data_wgew.zip", exdir = "./")  # Once this is unzipped, several files will be stored within the current directory.

###### From the data extracted ########

# Assign data.tables to variables
# These tables contain data aggregated at the watershed boundary (WGEW) and at different temporal scales from three main sources:
# PRISM 800m, IPCC, MODIS & Landsat
dt.seasons <- readRDS('dt.seasons.wgew.rds')  # Aggregated data by seasons from PRISM800m and IPCC (RCP scenerios 26 & 85).  
dt.annuals <- readRDS('dt.annuals.wgew.rds')  # Aggregated data by water year from PRISM800m and IPCC (RCP scenerios 26 & 85).  
dt.wgew <- readRDS('dt.wgew.rds')             # Observed data from WGEW based on the interpolation of raingages data
dt.maxndvi <- readRDS('dt.maxndvi.wgew.rds')  # Maximum NDVI values per year obtained from Google Earth Engine
dt.npp <- readRDS('dt.npp.wgew.rds')          # Net Primary Productivity from MODIS-Terra sensor (MOD17)


############## Assign rasters to variables ##################

# NLCD raster dominant lcover
nlcd.raster <- readRDS('r.dominant.lcover.rds')

# Data for NLCD/MLRA climate space and seasonal data
dt.agg.ppt.tmean.all <- readRDS('dt.agg.ppt.tmean.all.rds')
# Standard deviations rasters
dt.prism.mlra.std <- readRDS('dt.prism.mlra.std.rds')
 
# PAST
# These are rasterlayers showing the spatial comparison results from past climate conditions and current climate conditionts(WGEW)
past_hotter_and_wetter_than_ccWGEW <- readRDS('past_hotter_and_wetter_than_ccWGEW.rds')
past_hotter_and_drier_than_ccWGEW <- readRDS('past_hotter_and_drier_than_ccWGEW.rds')
past_colder_and_wetter_than_ccWGEW <- readRDS('past_colder_and_wetter_than_ccWGEW.rds')
past_colder_and_Drier_than_ccWGEW <- readRDS('past_colder_and_Drier_than_ccWGEW.rds')
past_wetter_and_similarTemp_to_ccWGEW <- readRDS('past_wetter_and_similarTemp_to_ccWGEW.rds')
past_drier_and_similarTemp_to_ccWGEW <- readRDS('past_drier_and_similarTemp_to_ccWGEW.rds')
past_hotter_and_similarPpt_to_ccWGEW <- readRDS('past_hotter_and_similarPpt_to_ccWGEW.rds')
past_colder_and_similarPpt_to_ccWGEW <- readRDS('past_colder_and_similarPpt_to_ccWGEW.rds')
past_similar_CC_to_ccWGEW <- readRDS('past_similar_CC_to_ccWGEW.rds')
r.pastPrecip <- readRDS('r.precip.past1950_1979.rds')
r.pastTemp <- readRDS('r.temp.past1950_1979.rds')

# CURRENT
# These are rasterlayers showing the spatial comparison results from current climate conditions around WGEW vs those within WGEW
current_hotter_and_wetter_than_ccWGEW <- readRDS('current_hotter_and_wetter_than_ccWGEW.rds')
current_hotter_and_drier_than_ccWGEW <- readRDS('current_hotter_and_drier_than_ccWGEW.rds')
current_colder_and_wetter_than_ccWGEW <- readRDS('current_colder_and_wetter_than_ccWGEW.rds')
current_colder_and_Drier_than_ccWGEW <- readRDS('current_colder_and_Drier_than_ccWGEW.rds')
current_wetter_and_similarTemp_to_ccWGEW <- readRDS('current_wetter_and_similarTemp_to_ccWGEW.rds')
current_drier_and_similarTemp_to_ccWGEW <- readRDS('current_drier_and_similarTemp_to_ccWGEW.rds')
current_hotter_and_similarPpt_to_ccWGEW <- readRDS('current_hotter_and_similarPpt_to_ccWGEW.rds')
current_colder_and_similarPpt_to_ccWGEW <- readRDS('current_colder_and_similarPpt_to_ccWGEW.rds')
current_similar_CC_to_ccWGEW <- readRDS('current_similar_CC_to_ccWGEW.rds')
r.currentPrecip <- readRDS('r.precip.current1980_2013.rds')
r.currentTemp <- readRDS('r.temp.current1980_2013.rds')

# FUTURE
# These are rasterlayers showing the spatial comparison results for future climate conditions around WGEW vs current conditions within WGEW
future_hotter_and_wetter_than_ccWGEW <- readRDS('future_hotter_and_wetter_than_ccWGEW.rds')
future_hotter_and_drier_than_ccWGEW <- readRDS('future_hotter_and_drier_than_ccWGEW.rds')
future_colder_and_wetter_than_ccWGEW <- readRDS('future_colder_and_wetter_than_ccWGEW.rds')
future_colder_and_Drier_than_ccWGEW <- readRDS('future_colder_and_Drier_than_ccWGEW.rds')
future_wetter_and_similarTemp_to_ccWGEW <- readRDS('future_wetter_and_similarTemp_to_ccWGEW.rds')
future_drier_and_similarTemp_to_ccWGEW <- readRDS('future_drier_and_similarTemp_to_ccWGEW.rds')
future_hotter_and_similarPpt_to_ccWGEW <- readRDS('future_hotter_and_similarPpt_to_ccWGEW.rds')
future_colder_and_similarPpt_to_ccWGEW <- readRDS('future_colder_and_similarPpt_to_ccWGEW.rds')
future_similar_CC_to_ccWGEW <- readRDS('future_similar_CC_to_ccWGEW.rds')
r.futurePrecip <- readRDS('r.precip.future2014_2044.rds')
r.futureTemp <- readRDS('r.temp.future2014_2044.rds')

# Create a raster stack for temperature and precipitation
rst <- stack(r.pastTemp,r.currentTemp, r.futureTemp)
rsp <- stack(r.pastPrecip,r.currentPrecip, r.futurePrecip)

############ Assign vector objects to variables 
wgew <- readRDS('r.wgew.poly.rds')               # WGEW polygon
ltar.polys <- readRDS('ltarPolygons.rds')        # LTAR polygons (HUC12) 
rain.gages <- readRDS('v.wgew.raingages.rds')    # Raingages in WGEW

############ Setup variables for plots in ggplot  ####################
# Set theme for standard plot
var.themes1 <- theme_bw() + theme(plot.title=element_text(family="Helvetica", face="bold", size=20)) + theme(axis.text.x = element_text(hjust = 0.1, size=14,color="grey40")) + theme(axis.text.y = element_text(hjust = 0.1, size=14,color="grey40")) + theme(axis.title.x=element_text(family="Helvetica",  size=16)) + theme(axis.title.y=element_text(family="Helvetica",  size=16)) + theme(legend.title=element_text(family="Helvetica",  size=16)) + theme(legend.text=element_text(family="Helvetica",  size=14)) + theme(text=element_text(size=12, family="Helvetica"))

# Set theme for facet plots  
var.themes2 <- theme_bw() + theme(plot.title=element_text(family="Helvetica", face="bold", size=20)) + theme(axis.text.x = element_text(hjust = 0.1, size=14,color="grey40")) + theme(axis.text.y = element_text(hjust = 0.1, size=14,color="grey40")) + theme(axis.title.x=element_text(family="Helvetica",  size=16)) + theme(axis.title.y=element_text(family="Helvetica",  size=16)) + theme(legend.title=element_text(family="Helvetica",  size=16)) + theme(legend.text=element_text(family="Helvetica",  size=14)) + theme(strip.text.y = element_text(size = 14)) 

# Set theme for plots requiring small labels on ticks  
var.themes3<- theme_bw() + theme(plot.title=element_text(family="Helvetica", face="bold", size=20)) + theme(axis.text.x = element_text(hjust = 0.1, size=10,color="grey40")) + theme(axis.text.y = element_text(hjust = 0.1, size=10,color="grey40")) + theme(axis.title.x=element_text(family="Helvetica",  size=16)) + theme(axis.title.y=element_text(family="Helvetica",  size=16)) + theme(legend.title=element_text(family="Helvetica",  size=16)) + theme(legend.text=element_text(family="Helvetica",  size=14)) + theme(strip.text.y = element_text(size = 14)) 

#----------------------------------------------------------------------------------------#
############################### FUNCTIONS section #######################################
# We can keep adding functions that can be useful for some modeling, plotting, etc.
#########################################################################################
GetScatterPlot <- function(vdata,x,y, coordX=0, coordY=0,xLab="",yLab="",eq=FALSE, vSmooth = "lm") {
  # Get a scatter plot using ggplot  
  #
  # Args:
  #   vdata: a data.table/dataframe with the data containing the vectors for x,y plot.
  #   x: a string value with the name of the column to use for "x".
  #   y: a string value with the name of the column to use for "y".
  #   coordX: a numeric integer value to define the x-coordinate within the plot, values are in units of the corresponding x-column.
  #   coordY: a numeric integer value to define the y-coordinate within the plot, values are in units of the corresponding y-column.
  #   xLab: a string value to customize x-axis title.
  #   yLab: a string value to customize y-axis title.
  #   eq: a boolean value to indicate if equation should be added over the plot, default is FALSE.
  #   vSmooth: a string value to identify the type of fit, default is "lm".
  #
  # Returns: 
  #   A ggplot scatterplot object.
  
  vEq <- function(vdata,x,y){
        f <- as.formula(paste(y,"~", x))
        m <- lm(f, vdata)
        eq <- substitute(italic(y) == a + b %.% italic(x)*","~~italic(r)^2~"="~r2, 
                         list(a = format(coef(m)[1], digits = 2), 
                              b = format(coef(m)[2], digits = 2), 
                              r2 = format(summary(m)$r.squared, digits = 3)))
        as.character(as.expression(eq));                
   } 
  rp <- ggplot(vdata, aes_string(y=y,x=x)) +
               geom_point() + 
               geom_smooth(method=vSmooth, fill=NA) +
               xlab(xLab) + ylab(yLab) + 
               var.themes2 + 
               geom_text(x = coordX, y = coordY, label = ifelse(eq, vEq(vdata,x,y), ""), size = 6, family="Helvetica", parse = TRUE)
  
  return(rp)
}

# Some other useful functions can be added here
######################################## END-Functions section ##############################
```
<!-- ##### HTML can be used for formatting text or including images (png,jpg), etc  #### -->

<div id="header">
  <center><img src="arslogo.png" alt=""></center>
</div>  
<br>

# The Long-Term Agroecosystem Research (LTAR) network  

This is an application of a R-notebook to show the workflow for a single LTAR location. One of the main goals of this notebook is to present an approach to facilitate collaboration on cross-site LTAR network experiments by enabling an interface to address some of the main challenges in collaborative research such as data sharing and reproducibility. 

Through this platform we can incorporate different data sources, test different models, explore several plotting and reporting capabilities, present spatial information and make it available to anyone within LTAR. The code of this notebook can be downloaded as .Rmd file for using in RStudio Integrated Development Environment. In addition, the following content can be accessed through the <a href="https://walnutgulch-ltar.shinyapps.io/LTARclimate"> LTAR-Climate dashboard </a> for different LTAR locations.
<br>
<br>

***
<center><h3> Walnut Gulch Experimental Watershed (WGEW) </h3></center>
<br>

The Walnut Gulch Experimental Watershed (WGEW) encompasses the 150 square
kilometers in southeastern Arizona, U.S.A. that surrounds the historical western town of
Tombstone. The watershed is contained within the upper San Pedro River Basin which encompasses 7600 square kilometers in Sonora, Mexico and Arizona and is representative of approximately 60 million hectares of brush and grass covered rangeland found throughout the semi-arid southwest and is a transition zone between the Chihuahuan and Sonoran Deserts. Elevation of the watershed ranges from 1250 m to 1585 m MSL. Cattle grazing is the primary land use with mining, limited urbanization, and recreation making up the remaining uses. Walnut Gulch, being dry about 99% of the time, is an ephemeral tributary of the San Pedro River.

<br>
<br>
```{r echo=FALSE, message=FALSE, warning=FALSE}
# Draw the map of the boundaries of this location, for mapping we are using R-package Leaflet.

# This is just an icon for a raingage
rg_icon <- makeIcon(
     iconUrl = "https://ftp.arsnet.usda.gov/Fileshare/PublicShare/FileDownload.ashx?value=RZ7pM2PNOKkljvTbT3w+u630Yir3HU0+2CC8jE9x/PJQG52ra8sCHg==",
     iconWidth = 28, iconHeight = 28
    ) 
    # Get lat/lng to setview area
    tmp<-fortify(ltar.polys[ltar.polys$ID==params$key,])
    tmpLat <-mean(tmp$lat)
    tmpLng <- mean(tmp$long)
    
    # For mapping raingages, I guess, this can be done in many different ways... 
    rg <- as.data.table(rain.gages@coords)[,list(latitude=coords.x2,longitude=coords.x1)]
    rg <- rg[,rg_code:=as.data.table(rain.gages@data)[,list(rg_code=I_Name)]]
     
    # Here we use leaflet package to display spatial data 
    map <- leaflet(wgew, width = "100%") %>%
      addProviderTiles('CartoDB.Positron', options = tileOptions(minZoom=0, maxZoom=16), group = "Map") %>%
      addTiles("http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", group = "Satellite") %>%
      clearShapes() %>%
      setView(lat= tmpLat, lng=tmpLng, zoom = 11) %>%
      addPolygons(smoothFactor = 0, weight=1,
                  fillColor ="#FFFF00" , color="#0000FF", fillOpacity = 0.5, 
                  layerId = ~ID) %>%
      addLayersControl(c("Map", "Satellite"),   # Add sat/map layers from the link above at arcgisonline
                       options = layersControlOptions(collapsed = FALSE)) %>%
      addMarkers(lng = ~ rg$longitude, lat = ~ rg$latitude, icon = rg_icon, popup = ~ as.character(rg$rg_code))  # Add raingages layer
    map
    
```
<b>Figure 1.</b> The Walnut Gulch Experimental Watershed (WGEW) boundary. The icons overlaying the map show the location of each raingage (digital) across the watershed.
<br>

The following sections present climate and remote sensing of vegetation data for WGEW.  All the the data and code is from the <a href="https://walnutgulch-ltar.shinyapps.io/LTARclimate"> LTAR-Climate dashboard. </a>  

<br>

### Site- Temperature vs Precipitation 

<br>


```{r, message=FALSE, warning=FALSE, include=FALSE, results="hide"}
  
################## Scatterplot Prcp-Temp #############################
  
  # Setup variables for queries, this is used to display periods as labels e.g. "P_1952_2013"
  cn1 <- paste0("'P_",params$ystartP1,"_",params$yendP1,"'")
  expr1 <- parse(text = paste0("PERIOD:=",cn1))
  cn2 <- paste0("'P_",params$ystartP2,"_",params$yendP2,"'")
  expr2 <- parse(text = paste0("PERIOD:=",cn2))
  cn3 <- paste0("'P_",params$ystartP3,"_",params$yendP3,"'")
  expr3 <- parse(text = paste0("PERIOD:=",cn3))
  
  # This was created based on the shapefile of HUC12, some of the names in the HUC12 were not exactly as the official LTAR name
  ltarList <- structure(c(5L, 13L, 3L, 17L, 2L, 10L, 9L, 
  7L, 4L, 6L, 14L, 15L, 12L, 1L, 
  18L, 16L, 11L, 8L), .Names = c("Archbold BS", "Central Mississippi", "Central Plains ER", "Eastern Corn Belt", "Great Basin", "Gulf Atlantic CP", "Jornada ER", "Kellog BS", "Lower Chesapeake", "Lower Mississippi", 
  "Northern Plains", "Platte River", "R.J. Cook AS", "Southern Plains", "Texas Gulf", "Upper Chesapeake Bay", 
  "Upper Mississippi", "Walnut Gulch"))
  
  # Querying data from dt.annuals for temperature and precipitation
  dt.sp.ltar <- dt.annuals[MODEL==params$IPCC_model & VARIABLE=='TMEAN', list(FID,STATE_NAME,YEAR,MODEL,SEASON,Temperature=VALUE)]
  
  dt.sp.ltar[,Precipitation:=dt.annuals[MODEL==params$IPCC_model & VARIABLE=='PRCP', list(VALUE)]]
  
  # Add periods labels
  dt.sp.ltar[YEAR >= params$ystartP1 & YEAR <= params$yendP1,eval(expr1)]
  dt.sp.ltar[YEAR >= params$ystartP2 & YEAR <= params$yendP2,eval(expr2)]
  dt.sp.ltar[YEAR >= params$ystartP3 & YEAR <= params$yendP3,eval(expr3)]
  
  # This is where those years out of the periods selected are  filtered out  
  dt.sp.ltar<-unique(dt.sp.ltar[!is.na(PERIOD),list(STATE_NAME,SEASON,Temperature=mean(Temperature),Precipitation=mean(Precipitation)), by=c('FID','SEASON','PERIOD')]) 
  setkey(dt.sp.ltar,FID)
   
  # Change the Name of watersheds
  dt1 <- as.data.table(t(ltarList))
  dt1 <- data.table(LTAR_NAME=rownames(t(dt1)),FID=as.data.table(t(dt1))$V1)
  setkey(dt1,FID)
  
  # Make a join to get LTAR names, this just apply when there are several locations (e.g. dashboard) 
  dt.sp.ltar <- dt1[dt.sp.ltar]
  
  # Get a max value for displaying                          
  vmax <- max(dt.sp.ltar$Precipitation) + 50
  
```

```{r, echo=FALSE, fig.height=7.5, fig.width=12.5, message=FALSE, warning=FALSE}
  p_sp <- ggplot(dt.sp.ltar, aes(Temperature,Precipitation, label=LTAR_NAME, colour=LTAR_NAME)) +
               geom_point(aes(color=PERIOD), size=2) +
               geom_smooth(method="lm", fill=NA) + 
               scale_color_manual("",values=c("#5d8aa8","#d2691e","#e32636","#adff2f","#ff7518","#ffbf00","#23297a","#9966cc","#fc6c85","#fc0fc0","#cd9575","#ff2400","#008000","#0f52ba","#8db600","#fbceb1","#00ffff","#7b1113","#4b5320", "#e9d66b","#ffff00")) +
                xlab ('Temperature (Â°C)') + ylab ('Precipitation (mm)') +
                var.themes2 +   
                scale_y_continuous(limits=c(0,vmax), expand = c(0, 0)) +
                facet_grid(SEASON ~ ., scales="free_y", space="free_x") +
                scale_y_continuous(expand = c(0, 0)) +
                theme(strip.background = element_blank()) +
                theme(panel.border = element_rect(colour = "black", fill=NA, size=0.5))   
  p_sp 
  
### For some plots we use plotly for R (http://plot.ly/) to convert ggplots into plotly graphs (ggplotly), which can provide some interactivity. However, there are still some features that are not fully working. Thus, anytime the plotly (below) is commented it means that some features didn't work well ###
  
  #g <- ggplotly(p_sp)  
  #build <- plotly_build(g)
  #build 
  
```
<br>
<b>Figure 2.</b> Annual average values of precipitation and temperature by season and for three time periods. Each point represents an average of a 30 yrs. period. Data from ```r params$ystartP1``` to ```r params$yendP2``` are from PRISM 800m and from 2014 to 2050 were obtained from IPCC scenario ```r params$IPCC_model ```. For the spatial aggregation we used WGEW boundaries.

<br>


```{r, message=FALSE, warning=FALSE, include=FALSE, results="hide"}
   # Setup for  Monthly precipitation comparison   
   cn1 <- paste0("P_",params$ystartP1,"_",params$yendP1)
   expr1 <- parse(text = paste0(cn1,"=VALUE"))
   cn2 <- paste0("P_",params$ystartP2,"_",params$yendP2)
   expr2 <- parse(text = paste0(cn2,"=VALUE"))
   cn3 <- paste0("P_",params$ystartP3,"_",params$yendP3)
   expr3 <- parse(text = paste0(cn3,"=VALUE")) 
  
   vcols <-c('VALUE')
   l1<-melt(dt.seasons[FID==params$key & MODEL==params$IPCC_model & VARIABLE=='PRCP' & year(DATE) <= params$yendP1 & year(DATE) >= params$ystartP1, lapply(.SD, mean),.SDcols=vcols, by=month(DATE)][order(month)][,list(Month=month, eval(expr1))],id.vars=c('Month'), variable.name='Period', value.name='Precipitation')
   
   l1[, Period:=(cn1)]
   l2 <- melt(dt.seasons[FID==params$key & MODEL==params$IPCC_model & VARIABLE=='PRCP' & year(DATE) <= params$yendP2 & year(DATE) >= params$ystartP2, lapply(.SD, mean),.SDcols=vcols,by=month(DATE)][order(month)][,list(Month=month,eval(expr2))], id.vars=c('Month'), variable.name='Period', value.name='Precipitation')
   l2[, Period:=(cn2)]  
   l3 <- melt(dt.seasons[FID==params$key & MODEL==params$IPCC_model & VARIABLE=='PRCP' & year(DATE) <= params$yendP3 & year(DATE) >= params$ystartP3, lapply(.SD, mean),.SDcols=vcols,by=month(DATE)][order(month)][,list(Month=month,eval(expr3))], id.vars=c('Month'), variable.name='Period', value.name='Precipitation')
   l3[, Period:=(cn3)]
   
   dt.months.prcp <- rbindlist(list(l1,l2,l3))
   dt.months.prcp[,MONTH:=month.abb[Month]]
   dt.months.prcp[,MONTH:=factor(dt.months.prcp$MONTH, levels=dt.months.prcp$MONTH)]
```

```{r, echo=FALSE, fig.height=7.5, fig.width=12.5, message=FALSE, warning=FALSE}

   p_pm <- ggplot(dt.months.prcp, aes(MONTH,Precipitation, fill=Period)) +
               geom_bar(stat="identity", position="dodge") + 
               scale_fill_brewer(palette="Set1") +
               xlab ('Month') + ylab ('Precipitation (mm)') +
               var.themes1
   # ggplotly setup/call
   g <- ggplotly(p_pm)
   build <- plotly_build(g)
   build
```
<b>Figure 3.</b> Average monthly total precipitation for three periods at WGEW.  Precipitation values were averaged by month of year for each period of time.

<br>

```{r, message=FALSE, warning=FALSE, include=FALSE, results="hide"}
  
### Setup data for the specific location, params$IPCC_model, variable & time  ##########

  l1<-melt(dt.seasons[FID==params$key & MODEL==params$IPCC_model & VARIABLE=='TMEAN' & year(DATE) <= params$yendP1 & year(DATE) >= params$ystartP1, lapply(.SD, mean),.SDcols=vcols, by=month(DATE)][order(month)][,list(Month=month, eval(expr1))],id.vars=c('Month'), variable.name='Period', value.name='Temperature')
   
   l1[, Period:=(cn1)]
   l2 <- melt(dt.seasons[FID==params$key & MODEL==params$IPCC_model & VARIABLE=='TMEAN' & year(DATE) <= params$yendP2 & year(DATE) >= params$ystartP2, lapply(.SD, mean),.SDcols=vcols,by=month(DATE)][order(month)][,list(Month=month,eval(expr2))], id.vars=c('Month'), variable.name='Period', value.name='Temperature')
   l2[, Period:=(cn2)]  
   l3 <- melt(dt.seasons[FID==params$key & MODEL==params$IPCC_model & VARIABLE=='TMEAN' & year(DATE) <= params$yendP3 & year(DATE) >= params$ystartP3, lapply(.SD, mean),.SDcols=vcols,by=month(DATE)][order(month)][,list(Month=month,eval(expr3))], id.vars=c('Month'), variable.name='Period', value.name='Temperature')
   l3[, Period:=(cn3)]
   
   dt.months.tmean <- rbindlist(list(l1,l2,l3))
   dt.months.tmean[,MONTH:=month.abb[Month]]
   dt.months.tmean[,MONTH:=factor(dt.months.tmean$MONTH, levels=dt.months.tmean$MONTH)]
   
```

```{r, echo=FALSE, fig.height=5.8, fig.width=11.38, message=FALSE, warning=FALSE}
  p_pm <- ggplot(dt.months.tmean, aes(MONTH,Temperature, fill=Period)) +
                geom_bar(stat="identity", position="dodge") + 
                scale_fill_brewer(palette="Set2") +
                xlab ('Month') + ylab ('Temperature (Â°C)') +
                var.themes1
          
   # ggplotly setup/call 
   g <- ggplotly(p_pm)
   build <- plotly_build(g)
   build
```
<br>
<b>Figure 4.</b> Average monthly temperature for three periods at WGEW.  
```{r message=FALSE, warning=FALSE, include=FALSE, results="hide"}
  
### Setup data for time series ##########
  dt.annuals[,DYEAR:=as.Date(paste0(YEAR,"-01-01"))]
  vmax <- max(dt.annuals[FID==params$key & MODEL==params$IPCC_model & VARIABLE == 'PRCP']$VALUE) + 50
  
```
<br>

```{r, echo=FALSE, fig.height=5.8, fig.width=11.38, message=FALSE, warning=FALSE}
  p_precip<- ggplot(dt.annuals[FID==params$key & MODEL==params$IPCC_model & VARIABLE == 'PRCP'],
                   aes(x = DYEAR, y = VALUE, colour=SEASON)) +
              geom_point(aes(),size = 0.5)  +  
              scale_x_date(limits = as.Date(c("1900-06-01","2050-06-01"), "%Y"), date_breaks = "10 years", date_labels = "%y", expand = c(0,0))+
              stat_smooth(method = "loess", formula = y ~ x, size = 0.5, se = FALSE)+ 
              annotate("rect", xmin=as.Date("2014-01-01","%Y"), xmax=as.Date("2050-01-01","%Y"), ymin=0, ymax=vmax, alpha=0.2, fill="grey20") +
              ylab ('Precipitation (mm)') + xlab('Year') +
              var.themes1 + 
              scale_y_continuous(limits=c(0,vmax), expand = c(0, 0)) +
              theme(legend.justification=c(1,0), legend.position=c(1,0.70)) +
              guides(col = guide_legend(ncol = 3)) +
              scale_color_manual(values=c("red", "green","blue")) 
  # ggplotly setup/call
  g <- ggplotly(p_precip)
  build <- plotly_build(g)
  build

```
<br>
<b>Figure 5</b>. Seasonal Precipitation (1901-2050).
```{r message=FALSE, warning=FALSE, include=FALSE, results="hide"}
  
### Setup data for time series ##########
  dt.annuals[,DYEAR:=as.Date(paste0(YEAR,"-01-01"))]
  vmin <- min(dt.annuals[FID==params$key & MODEL==params$IPCC_model & VARIABLE == 'TMEAN']$VALUE) - 1.5  
  vmax <- max(dt.annuals[FID==params$key & MODEL==params$IPCC_model & VARIABLE == 'TMEAN']$VALUE) + 1.5
```
<br>

```{r, echo=FALSE, fig.height=5.8, fig.width=11.38, message=FALSE, warning=FALSE}

  p_tmean<- ggplot(dt.annuals[FID==params$key & MODEL==params$IPCC_model & VARIABLE == 'TMEAN'],
                   aes(x = DYEAR, y = VALUE, colour=SEASON)) +
              geom_point(aes(),size = 0.5)  +  
              scale_x_date(limits = as.Date(c("1900-06-01","2050-06-01"), "%Y"), date_breaks = "10 years", date_labels = "%y", expand = c(0,0))+
              stat_smooth(method = "loess", formula = y ~ x, size = 0.5, se = FALSE)+
              annotate("rect", xmin=as.Date("2014-01-01","%Y"), xmax=as.Date("2050-01-01","%Y"), ymin=vmin, ymax=vmax, alpha=0.2, fill="grey20") +
              ylab ("Temperature (Â°C)") + xlab('Year') +
              var.themes1 + 
              scale_y_continuous(limits=c(vmin,vmax), expand = c(0, 0)) +
              theme(legend.justification=c(1,0), legend.position=c(1,0.70)) +
              guides(col = guide_legend(ncol = 3)) +
              scale_color_manual(values=c("red", "green","blue"))   
  # ggplotly setup/call
  g <- ggplotly(p_tmean) 
  build <- plotly_build(g)
  
  build

```
<br>
<b>Figure 6.</b> Seasonal Temperature (1901-2050).

<br>

```{r message=FALSE, warning=FALSE, include=FALSE, results="hide"}

  ### Setup data for convex hulls ### 

  find_hull <- function(dt) dt[chull(dt$TEMP,dt$PRCP),]   ## Format function for ggplot convex hull
  dtt<- dt.seasons[FID==params$key & MODEL==params$IPCC_model & (VARIABLE=='PRCP' | VARIABLE=='TMEAN'), list(VARIABLE,VALUE,PERIOD=year(DATE))]
  dtt[PERIOD >= params$ystartP1 & PERIOD<=params$yendP1, Period:=paste0(params$ystartP1,"_",params$yendP1)]
  dtt[PERIOD >= params$ystartP3 & PERIOD<=params$yendP3 , Period:=paste0(params$ystartP3,"_",params$yendP3)] 
  dtt <- dtt[!is.na(Period),]
  dtc <- dtt[VARIABLE=='TMEAN',list(Period,TEMP=VALUE)]
  dtc[,PRCP:=dtt[VARIABLE=='PRCP', list(VALUE)]]
  dtc[,Period:=as.factor(Period)]
  hulls<-ddply(dtc, "Period", find_hull)
  hulls$Period <- as.factor(hulls$Period)
  
```

```{r, echo=FALSE, fig.height=5.8, fig.width=11.38, message=FALSE, warning=FALSE}

  p_ch<-ggplot(data=dtc, aes(x=TEMP,y=PRCP)) +
    geom_point(aes(colour=Period),alpha=0.3, size=0.5) +
    geom_polygon(data=hulls, alpha=0.3, aes(group=Period, fill=Period), show.legend = FALSE) +
    #labs(x=expression(bold(paste("Temperature (", degree~C,")"))), y="Precipitation (mm)") +
    #ggtitle("Climate space of two time periods") +
    theme(plot.title=element_text(family="Helvetica", face="bold", size=20)) +
    theme(axis.title.x=element_text(family="Helvetica", face="bold", size=18))+
    theme(axis.title.y=element_text(family="Helvetica", face="bold", size=18)) +
    xlab ('Temperature (Â°C)') + ylab('Precipitation (mm)') +
    var.themes1 
  
  # ggplotly setup/call
  g <- ggplotly(p_ch) 
  build <- plotly_build(g)
  build


```
<br>
<b>Figure 7.</b> Climate space of two time periods.

<br>

```{r message=FALSE, warning=FALSE, include=FALSE, results="hide"}
### Setup SPEI data ###
  dt.tmp<-dt.seasons[FID==params$key & VARIABLE=='SPEI' & MODEL==params$IPCC_model & SEASON==params$vSeason]
  t <- seq.Date(as.Date('1901-10-01'), as.Date('2050-09-01'), by='month')
  dt.tmp[,t:=t,]
  y <- dt.seasons[FID==params$key & VARIABLE=='SPEI' & MODEL==params$IPCC_model & SEASON==params$vSeason]$VALUE
  dt.tmp[,y:=y]
  
 dt.tmp[,YEAR:=t]  
 vymin <- min(dt.tmp$y)
 vymax <- max(dt.tmp$y)
 
```

```{r, echo=FALSE, fig.height=5.8, fig.width=11.38, message=FALSE, warning=FALSE}

## Plot
  p_spei <- ggplot(dt.tmp, aes(DATE)) + geom_line(aes(t,y), color="light grey")+
      geom_ribbon(aes(ymin=0,ymax=pmax(0,y)),fill="blue") +
      geom_ribbon(aes(ymin=pmin(0,y),ymax=0),fill="red") +
      scale_x_date(limits = as.Date(c("1901-10-01","2050-10-01")), date_breaks = "9 years", date_labels = "%Y", expand = c(0, 0)) +
      ylab ('SPEI') + xlab('DATE') +
      var.themes3 +
      annotate("rect", xmin=as.Date("2014-01-01","%Y"), xmax=as.Date("2050-09-01","%Y"), ymin=vymin-0.5, ymax=vymax+0.5, alpha=0.2, fill="grey20") 
  
  # ggplotly setup/call
  g <- ggplotly(p_spei)
  build <- plotly_build(g)

  build
  
```
<br>
<b>Figure 8.</b> Annual Standardized Precipitation Evapotranspiration Index (SPEI)

<br>

### Climate Probabilistic Density Functions (PDF)

```{r message=FALSE, warning=FALSE, include=FALSE, results="hide"}
### Setup PDF data ###
  dist1<-dt.seasons[FID==params$key & MODEL==params$IPCC_model & (VARIABLE=='PRCP' | VARIABLE=='TMEAN') & year(DATE) <= params$yendP1 & year(DATE) >= params$ystartP1]
 dist1[VARIABLE=='TMEAN', Period:=(cn1)]
 dist1[VARIABLE=='PRCP', Period:=(cn1)]
 
 dist2<-dt.seasons[FID==params$key & MODEL==params$IPCC_model & (VARIABLE=='PRCP' | VARIABLE=='TMEAN') & year(DATE) <= params$yendP2 & year(DATE) >= params$ystartP2]
 dist2[VARIABLE=='TMEAN', Period:=(cn2)]
 dist2[VARIABLE=='PRCP', Period:=(cn2)]
 
 dist3<-dt.seasons[FID==params$key & MODEL==params$IPCC_model & (VARIABLE=='PRCP' | VARIABLE=='TMEAN') & year(DATE) <= params$yendP3  & year(DATE) >= params$ystartP3]
 dist3[VARIABLE=='TMEAN', Period:=(cn3)]
 dist3[VARIABLE=='PRCP', Period:=(cn3)]

  l<-list(dist1,dist2,dist3)
 dt.dist<-rbindlist(l)  
 
 dt.distPlot <- dt.dist[VARIABLE=='TMEAN']
```

```{r, echo=FALSE, fig.height=5.8, fig.width=11.38, message=FALSE, warning=FALSE}
pc<- ggplot(dt.distPlot, aes(VALUE,  colour=Period)) +
 geom_density(alpha = 0.5) + 
 ylab("Density") + xlab("Temperature (Â°C)") +
 var.themes2 + 
 facet_grid(SEASON~., scales="free_y", space="free_x") +
 scale_x_continuous(limits=c(min(dt.distPlot$VALUE)-5,max(dt.distPlot$VALUE)+5),expand =c(0,0)) + 
 scale_y_continuous(expand = c(0, 0)) +
 theme(strip.background = element_blank()) +
 theme(panel.border = element_rect(colour = "black", fill=NA, size=0.5))   
pc

```
<br>
<b>Figure 9.</b> Temperature PDF for three time periods at WGEW.

<br>

```{r message=FALSE, warning=FALSE, include=FALSE, results="hide"}
### Setup PDF data ###
dist1<-dt.seasons[FID==params$key & MODEL==params$IPCC_model & (VARIABLE=='PRCP' | VARIABLE=='TMEAN') & year(DATE) <= params$yendP1 & year(DATE) >= params$ystartP1]
 dist1[VARIABLE=='TMEAN', Period:=(cn1)]
 dist1[VARIABLE=='PRCP', Period:=(cn1)]
 
 dist2<-dt.seasons[FID==params$key & MODEL==params$IPCC_model & (VARIABLE=='PRCP' | VARIABLE=='TMEAN') & year(DATE) <= params$yendP2 & year(DATE) >= params$ystartP2]
 dist2[VARIABLE=='TMEAN', Period:=(cn2)]
 dist2[VARIABLE=='PRCP', Period:=(cn2)]
 
 dist3<-dt.seasons[FID==params$key & MODEL==params$IPCC_model & (VARIABLE=='PRCP' | VARIABLE=='TMEAN') & year(DATE) <= params$yendP3  & year(DATE) >= params$ystartP3]
 dist3[VARIABLE=='TMEAN', Period:=(cn3)]
 dist3[VARIABLE=='PRCP', Period:=(cn3)]

  l<-list(dist1,dist2,dist3)
 dt.dist<-rbindlist(l)  
 
 dt.distPlot <- dt.dist[VARIABLE=='PRCP']

```

```{r, echo=FALSE, fig.height=5.8, fig.width=9.38, message=FALSE, warning=FALSE}
pc <- ggplot(dt.distPlot, aes(VALUE, colour=Period)) +
 geom_density(alpha = 0.5) + 
 ylab("Density") + xlab("Precipitation (mm)") +
 var.themes2 + 
 facet_grid(SEASON~., scales="free_y", space="free_x") +
 scale_x_continuous(limits=c(min(dt.distPlot$VALUE)-50, max(dt.distPlot$VALUE)+50),expand =c(0,0)) + 
 scale_y_continuous(expand = c(0, 0)) +
 theme(strip.background = element_blank()) +
 theme(panel.border = element_rect(colour = "black", fill=NA, size=0.5))   
 
pc

```
<br>
<b>Figure 10.</b> Precipitation PDF for three time periods at WGEW.

<br>

### Measured vs Gridded

```{r message=FALSE, warning=FALSE, include=FALSE, results="hide"}
### Setup Annual Measured vs Gridded data ###
  
  dt.sp.pr.gs <- dt.seasons[FID==8 & DATE > as.Date("1980-09-01") & DATE < as.Date("2013-10-01") & MODEL==params$IPCC_model & VARIABLE=='PRCP' & SEASON=='Annual', list(PRISMppt = sum(VALUE)), by=WYR_YEAR]
  dt.sp.pr.gs[,WGEWppt:=dt.wgew[SEASON=='Annual',sum(PRECIPITATION), by=WYR_YEAR]$V1]
  
  
  vmax1 <- max(dt.sp.pr.gs$PRISMppt) + 40
  vmax2 <- max(dt.sp.pr.gs$WGEWppt) + 40

```

```{r, echo=FALSE, fig.height=5.8, fig.width=11.38, message=FALSE, warning=FALSE}

# Example on how to call "GetScatterPlot" function for a common scatterplot, see the definition of "GetScatterPlot" for some of the parameters 
p_sp <- GetScatterPlot(dt.sp.pr.gs, x="WGEWppt", y="PRISMppt", 
                       xLab="Measured Precipitation (mm)", yLab = "PRISM Precipitation (mm)")

# Add extra parameters to plot 
p_sp <-  p_sp + scale_x_continuous(expand = c(0,0), limits = c(150,vmax2)) + scale_y_continuous(expand = c(0,0), limits = c(150,vmax1))                       
# ggplotly setup/call
g <- ggplotly(p_sp)
build <- plotly_build(g)
build

```
<br>
<b>Figure 11.</b> Total annual precipitation values of measured (at WGEW) vs. gridded for the years with available gridded data (1980-2013).

<br>

```{r message=FALSE, warning=FALSE, include=FALSE, results="hide"}
### Setup Monthly Measured vs Gridded data ###
  
 dt.sp.pr.gs <- dt.seasons[FID==params$key & DATE > as.Date("1980-09-01") & DATE < as.Date("2013-10-01") & MODEL==params$IPCC_model & VARIABLE=='PRCP' & SEASON=='Annual', list(PRISMppt = VALUE)]
  dt.sp.pr.gs[,WGEWppt:=dt.wgew[SEASON=='Annual',list(PRECIPITATION)]]
  
  
  vmax1 <- max(dt.sp.pr.gs$PRISMppt) + 10
  vmax2 <- max(dt.sp.pr.gs$WGEWppt) + 10

```

```{r, echo=FALSE, fig.height=5.8, fig.width=11.38, message=FALSE, warning=FALSE}
  # Call GetScatterPlot function
  p_sp <- GetScatterPlot(dt.sp.pr.gs, x="WGEWppt", y="PRISMppt", 
                       xLab="Measured Precipitation (mm)", yLab = "PRISM Precipitation (mm)")

  p_sp <-  p_sp + scale_x_continuous(expand = c(0,0), limits = c(0,vmax2)) + scale_y_continuous(expand = c(0,0), limits = c(0,vmax1))

  # ggplotly setup/call
  g <- ggplotly(p_sp)
  build <- plotly_build(g)
  build


```
<br>
<b>Figure 12.</b> Total monthly precipitation values of measured vs. gridded for the years with available gridded data (1980-2013).

<br>

```{r message=FALSE, warning=FALSE, include=FALSE, results="hide"}
### Setup Summer Measured vs Gridded data ###
  
 dt.sp.pr.gs <- dt.seasons[FID==8 & DATE > as.Date("1980-09-01") & DATE < as.Date("2013-10-01") & MODEL==params$IPCC_model & VARIABLE=='PRCP' & SEASON=='Summer', list(PRISMppt = VALUE)]
  dt.sp.pr.gs[,WGEWppt:=dt.wgew[SEASON=='Summer',list(PRECIPITATION)]]
  
  
  vmax1 <- max(dt.sp.pr.gs$PRISMppt) + 10
  vmax2 <- max(dt.sp.pr.gs$WGEWppt) + 10

```

```{r, echo=FALSE, fig.height=5.8, fig.width=9.38, message=FALSE, warning=FALSE}
  
  p_sp <- GetScatterPlot(dt.sp.pr.gs, x="WGEWppt", y="PRISMppt", 
                       xLab="Measured Precipitation (mm)", yLab = "PRISM Precipitation (mm)")

  p_sp <- p_sp +  scale_x_continuous(expand = c(0,0), limits = c(0,vmax2)) + scale_y_continuous(expand = c(0,0), limits = c(0,vmax1))
 
  # ggplotly setup/call
  g <- ggplotly(p_sp)
  build <- plotly_build(g)
  build

```
<br>
<b>Figure 13.</b> Total precipitation over summer months (July-September) for measured vs. gridded data for the years with available gridded data (1980-2013).

<br>

```{r message=FALSE, warning=FALSE, include=FALSE, results="hide"}
### Setup Winter Measured vs Gridded data ###
  
  dt.sp.pr.gs <- dt.seasons[FID==8 & DATE > as.Date("1980-09-01") & DATE < as.Date("2013-10-01") & MODEL==params$IPCC_model & VARIABLE=='PRCP' & SEASON=='Winter', list(PRISMppt = VALUE)]
  dt.sp.pr.gs[,WGEWppt:=dt.wgew[SEASON=='Winter',list(PRECIPITATION)]]
  
  
  vmax1 <- max(dt.sp.pr.gs$PRISMppt) + 10
  vmax2 <- max(dt.sp.pr.gs$WGEWppt) + 10

```

```{r, echo=FALSE, fig.height=5.8, fig.width=9.38, message=FALSE, warning=FALSE}

  p_sp <- GetScatterPlot(dt.sp.pr.gs, x="WGEWppt", y="PRISMppt", 
                       xLab="Measured Precipitation (mm)", yLab = "PRISM Precipitation (mm)")

  p_sp <- p_sp + scale_x_continuous(expand = c(0,0), limits = c(0,vmax2)) + scale_y_continuous(expand = c(0,0), limits = c(0,vmax1))
  
  # ggplotly setup/call
  g <- ggplotly(p_sp)
  build <- plotly_build(g)
  build

```
<br>
<b>Figure 14.</b> Total precipitation over winter months (October-March) for measured vs. gridded data for the years with available gridded data (1980-2013).

<br>
<br>

### Production (Remote sensing data)

Data for annual Net Primary Production (NPP) was obtained from MODIS satellite product (MOD17).

<br>

```{r message=FALSE, warning=FALSE, include=FALSE, results="hide"}
### Setup SPEI vs ANPP (Issues from MOD17 are known and LPDAAC is working on fixing those) 
  dt.spei.ndvi <- dt.seasons[FID==params$key & WYR_YEAR>1998 & WYR_YEAR < 2013 & SEASON=='Annual' & MODEL==params$IPCC_model & VARIABLE=='SPEI',list(AvgSPEI=mean(VALUE, na.rm=TRUE)),by=c('FID','WYR_YEAR')]
  
  dt.spei.ndvi[,NPP:=dt.npp[ID==params$key & YEAR < 2014 & YEAR > 1999,list(NPP)]]
  
```

```{r, echo=FALSE, fig.height=5.8, fig.width=9.38, message=FALSE, warning=FALSE}
# Here we are filtering out years previous to 2004 due to some issues in MODIS product MOD17. LPDAAC is working on fixing these issues for those years.
  p_sp <- GetScatterPlot(dt.spei.ndvi[WYR_YEAR>2003], x="AvgSPEI", y="NPP", 
                       xLab="SPEI", yLab = "Annual NPP (KgCm<sup>2</sup>) <br>")
  # ggplotly setup/call
  g <- ggplotly(p_sp)
  build <- plotly_build(g)
  build
```
<br>
<b>Figure 15.</b> Annual values of SPEI vs Net Primary Production. 

<br>

```{r message=FALSE, warning=FALSE, include=FALSE, results="hide"}
### Setup PRCP vs Anual NPP
  dt.spei.ndvi <- dt.seasons[FID==params$key & WYR_YEAR>1999 & WYR_YEAR < 2014 & SEASON=='Annual' & MODEL==params$IPCC_model & VARIABLE=='PRCP',list(Precip=sum(VALUE, na.rm=TRUE)),by=c('FID','WYR_YEAR')]
  
  dt.spei.ndvi[,NPP:=dt.npp[ID==params$key & YEAR < 2014 & YEAR > 1999,list(NPP)]]
  
```

```{r, echo=FALSE, fig.height=5.8, fig.width=9.38, message=FALSE, warning=FALSE}
  p_sp <- GetScatterPlot(dt.spei.ndvi[WYR_YEAR>2003], x="Precip", y="NPP", 
                       xLab="Precipitation (mm)", yLab = "Annual NPP (KgCm<sup>2</sup>) <br>")
  # ggplotly setup/call
  g <- ggplotly(p_sp)
  build <- plotly_build(g)
  build
```
<br>
<b>Figure 16.</b> Precipitation and Annual Net Primary Production.

<br>

```{r message=FALSE, warning=FALSE, include=FALSE, results="hide"}
### Setup Temperature vs Anual NPP
   dt.spei.ndvi <- dt.seasons[FID==params$key & WYR_YEAR>1999 & WYR_YEAR < 2014 & SEASON=='Annual' & MODEL==params$IPCC_model & VARIABLE=='TMEAN',list(Temp=mean(VALUE, na.rm=TRUE)),by=c('FID','WYR_YEAR')]
  
  dt.spei.ndvi[,NPP:=dt.npp[ID==params$key & YEAR < 2014 & YEAR > 1999,list(NPP)]]
  
```

```{r, echo=FALSE, fig.height=5.8, fig.width=9.38, message=FALSE, warning=FALSE}
   
   p_sp <- GetScatterPlot(dt.spei.ndvi[WYR_YEAR>2003], x="Temp", y="NPP", 
                       xLab="Temperature (Â°C)", yLab = "Annual NPP (KgCm<sup>2</sup>) <br>")
   # ggplotly setup/call 
   g <- ggplotly(p_sp)
   build <- plotly_build(g)
   build
```
<br>
<b>Figure 17.</b> Temperature and Annual Net Primary Production.

<br>

### Landcover (NLCD-2011 data)


```{r message=FALSE, warning=FALSE, include=FALSE,}
  ########################## About Landcover data #####################################################################
  ### Data source: NLCD, 2011 from Google Earth Engine https://code.earthengine.google.com/
  ### The extent of the raster data (rectangle) covers the areas around WGEW.   
  ### Data extraction process involved these steps:
  ### 1. A jupyter python notebook was used to extract data (csv files) from NLCD, 2011 using a connection to Google Earth Engine to generate csv files
  ### 2. Files (csv) were processed in R to do the final aggregation and generate the data.tables used here.
  ### 3. For the spatial extrapolation comparison section, raster files were created using the aggregated values at 800m pixel size.  These rasters were saved as binary-R files (.rds) which are part of the zip file that is downloaded it at the begining of this notebook.

  vnlcd <- c(42,43,52,71,81,82)
  vdesc <- c("Evergreen Forest", "Mixed Forest","Shrub/Scrub","Grassland/Herbaceous","Pasture/Hay","Cultivated crops")
  vcolors <- c('#38814E','#D4E7B0','#DCCA8F','#FDE9AA','#FBF65D','#CA9146')
  r.pal.lcover <- colorFactor(c('#38814E','#D4E7B0','#DCCA8F','#FDE9AA','#FBF65D','#CA9146'), vnlcd, na.color="transparent")
 mlraMap <- leaflet(wgew, width = "100%") %>% 
  addTiles("http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}") %>%
  addRasterImage(nlcd.raster, colors = r.pal.lcover, group ="Dominant Landcover") %>%
  addLegend(position="topright", colors=vcolors, labels=vdesc, title = "Dominant Landcover, NLCD,2011", opacity=1.0) %>%
  addPolygons(
    fill=FALSE,color="red", weight=2, group="WGEW Extent")
#})
mlraMap

```

<br>


```{r message=FALSE, warning=FALSE, include=FALSE, results="hide"}
### Setup landcover-season
dt.agg.ppt.tmean.all$LCODE <- factor(dt.agg.ppt.tmean.all$LCODE,levels =c("MF","EG","SS","GH","PH","CC"))


```

```{r echo=FALSE, fig.height=5.8, fig.width=9.38, message=FALSE, warning=FALSE}

p1 <- ggplot(data=dt.agg.ppt.tmean.all, aes(x=AvgTMEAN, y=AvgPPT)) + 
            geom_point(aes(colour=factor(LCODE)), size=1) +
  theme_bw() + xlab("Temperature (Â°C)")+
  ylab("Precipitation (mm)") +
  var.themes2 +
  labs(color = "Landcover", caption="Data sources: PRISM 800m, NLCD-2011, NRCS") +
  guides(colour = guide_legend(override.aes = list(size=2))) +
  facet_grid(SEASON ~ .) +
  theme(strip.background = element_blank()) +
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.5))
  p1
  
  
```
<br>
<b>Figure 18.</b> Landcover seasonal climate data for MLRA41

<br>

```{r message=FALSE, warning=FALSE, include=FALSE, results="hide"}

### Setup hulls for climate space
 # Make the plot
  hulls <- dt.agg.ppt.tmean.all[, .SD[chull(AvgPPT,AvgTMEAN)],by=c('PERIOD','LCODE',                                                                  'SEASON')]
setK = 3
```

```{r echo=FALSE, fig.height=8.8, fig.width=15.38, message=FALSE, warning=FALSE}
p_ch<-ggplot(data=dt.agg.ppt.tmean.all, aes(x=AvgTMEAN,y=AvgPPT)) +
  geom_point(aes(colour=PERIOD), alpha=0.7, size=0.5) +
  geom_polygon(data=hulls, alpha=0.2, aes(group=PERIOD,colour=PERIOD), show.legend = FALSE) +
  theme_bw () +
  xlab("\nTemperature (Â°C)") + ylab("Precipitation (mm)\n") +
  var.themes2 +    
  labs(color = "Period", caption="Data sources: PRISM 800m, NLCD-2011, NRCS") +
  guides(colour = guide_legend(override.aes = list(size=2))) +
  facet_grid(SEASON ~ LCODE) +
  theme(strip.background = element_blank()) + 
  theme(panel.border = element_rect(colour = "black", fill=NA, size=0.5)) 
 p_ch
  # m = list( l = 200, r = 200, b = 70, t = 50, pad = 0 )
  # 
  # g <- ggplotly(p_ch)
  # build <- plotly_build(g)
  # build

```
<br>
<b>Figure 19.</b> Climate space by landcover 

<br>

```{r echo=FALSE, fig.height=8.8, fig.width=15.38, message=FALSE, warning=FALSE}
 p_std <- ggplot(data=dt.prism.mlra.std[SEASON %like% 'PPT'], aes(x=AVG, y=STD)) + 
  geom_point(aes(colour=LCODE), size=1) +
  ylab(" <br> STD") + xlab("Annual Avg. Precipitation (mm)")+
  var.themes2 +
  guides(colour = FALSE) +
  facet_grid(SEASON ~ . , scales = "free_y" ) +
    theme(strip.background = element_blank(),  strip.text.y = element_blank()) +
    theme(panel.border = element_rect(colour = "black", fill=NA, size=0.5)) 
    
  m = list( l = 50, r = 50, b = 70, t = 50, pad = 0 )
  g <- ggplotly(p_std)
  
# Change labels for strips 
season_names <- c(
                    `Annual_TMEAN` = "ANNUAL",
                    `Summer_TMEAN` = "SUMMER",
                    `Winter_TMEAN` = "WINTER"
                    )
p_std_tmean <- ggplot(data=dt.prism.mlra.std[SEASON %like% 'TMEAN'], aes(x=AVG, y=STD)) + 
  geom_point(aes(colour=LCODE), size=1) +
  ylab(" <br> STD")+ xlab("Annual Avg. Temperature (&deg;C)")+
  var.themes2 + 
  guides(colour = guide_legend(override.aes = list(size=3))) +
  facet_grid(SEASON ~ . , scales = "free_y", labeller = as_labeller(season_names)) +
    theme(strip.background = element_blank()) +
    theme(panel.border = element_rect(colour = "black", fill=NA, size=0.5)) 
  m = list( l = 200, r = 200, b = 70, t = 50, pad = 0 )
  # ggplotly setup/call 
  g2 <- ggplotly(p_std_tmean)
  build <- subplot(g,g2) 
  build
```
<br>
<b>Figure 20</b>. Standard deviation for seasonal temperarure and precipitation by landcover type.

<br>

### Spatial Extrapolation 

In this section we present a spatial comparison of the current climate conditions (CC) (1980-2013) at the WGEW (red polygon) with adjacent areas for expected future conditions. The thought is that we should know what area can expect to experience the range of temperature and precipitation that we currently observe on WGEW before thinking about resource responses to drivers into strategies to mitigate and adapt Americaâs agroecosystems to climate change.  We can see areas currently experiencing the climate that Walnut Gulch can expect in the future. 

<br>
```{r echo=FALSE, message=FALSE, warning=FALSE}
  ### Raster content is mapped in the following sections. 

  # Setup colors for mapping raster with past period precipitaiton
  r.pal.precip <- colorNumeric(c("#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c"), values(rsp), na.color="transparent")
  r.pal.temp <- colorNumeric(c("#ffffb2","#fecc5c","#fd8d3c","#f03b20","#bd0026"), values(r.pastTemp), na.color="transparent")
  
  mapPastPrecip <- leaflet(wgew, width = "100%")  %>% 
    addTiles("http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}") %>%
    addRasterImage(r.pastPrecip, colors = r.pal.precip, opacity=0.9, group ="Past Precip. 1950-1979") %>%
    addLegend(pal = r.pal.precip, values=values(rsp), opacity = 1, title = "Past Precip. (mm) <br> 1950-1979") %>%
    addPolygons(
    fill=FALSE,color="red", weight=2, group="WGEW Extent")
 
  mapPastPrecip
```
<br>
<b> Figure 21.</b> Average past total precipitation grid for 1950-1979.

<br>

```{r echo=FALSE, message=FALSE, warning=FALSE}

r.pal.temp <- colorNumeric(c("#ffffb2","#fecc5c","#fd8d3c","#f03b20","#bd0026"), values(r.pastTemp), na.color="transparent")
  
 mapPastTemp <- leaflet(wgew, width = "100%") %>% 
  addTiles("http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}") %>%
  addRasterImage(r.pastTemp, colors = r.pal.temp, opacity=0.9, group ="Past Temp. 1950-1979") %>%
  addLegend(pal = r.pal.temp, values=values(r.pastTemp), opacity = 1, title = "Past Temp. (C) <br> 1950-1979") %>%
  addPolygons(
    fill=FALSE,color="green", weight=2, group="WGEW Extent")
 
 mapPastTemp
 
```
<br>
<b>Figure 22.</b> Average past temperature grid for 1950-1979.

<br>

```{r echo=FALSE, message=FALSE, warning=FALSE}
pal1<-colorNumeric(c("white", "#40E0D0"), c(0,1.5),na.color="transparent")
  pal2<-colorNumeric(c("white", "red"), c(0,1.5),na.color="transparent")
  pal3<-colorNumeric(c("white", "black"), c(0,1.5),na.color="transparent")
  pal4<-colorNumeric(c("white", "yellow"), c(0,1.5),na.color="transparent")
  pal5<-colorNumeric(c("white", "blue"), c(0,1.5),na.color="transparent")
  pal6<-colorNumeric(c("white", "#FF1493"), c(0,1.5),na.color="transparent")
  pal7<-colorNumeric(c("white", "#7CFC00"), c(0,1.5),na.color="transparent")
  pal8<-colorNumeric(c("white", "#DAA520"), c(0,1.5),na.color="transparent")
  pal9<-colorNumeric(c("white", "#8B4513"), c(0,1.5),na.color="transparent")
  pal10<-colorNumeric(c("white", "#8B4513"), c(0,1.5),na.color="transparent")
  pal11<-colorNumeric(c("white", "#8B4513"), c(0,1.5),na.color="transparent")
 
 mapPast<- leaflet(wgew, width = "100%") %>% 
  addTiles("http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}") %>%
  addRasterImage(past_similar_CC_to_ccWGEW, colors = pal1, opacity=0.7, group ="Similar") %>%
  addRasterImage(past_hotter_and_wetter_than_ccWGEW, colors = pal2, opacity=0.7, group ="Hotter & wetter") %>%
  addRasterImage(past_hotter_and_drier_than_ccWGEW, colors = pal3, opacity=0.7, group ="Hotter & drier") %>%
  addRasterImage(past_colder_and_wetter_than_ccWGEW, colors = pal4, opacity=0.7, group ="Colder & wetter") %>%
  addRasterImage(past_colder_and_Drier_than_ccWGEW, colors = pal5, opacity=0.7, group ="Colder & drier") %>%
  addRasterImage(past_wetter_and_similarTemp_to_ccWGEW, colors = pal6, opacity=0.7, group ="Wetter & similar temp.") %>%
  addRasterImage(past_drier_and_similarTemp_to_ccWGEW, colors = pal7, opacity=0.7, group ="Drier & similar temp.") %>%
  addRasterImage(past_hotter_and_similarPpt_to_ccWGEW, colors = pal8, opacity=0.7, group ="Hotter & similar ppt.") %>%
  addRasterImage(past_colder_and_similarPpt_to_ccWGEW, colors = pal9, opacity=0.7, group ="Colder & similar ppt.") %>%  
    
  
  
  addLegend(
    position='bottomright',
    colors = c("#40E0D0","red", "black","yellow","blue","#FF1493","#7CFC00","#DAA520","#8B4513"),
    labels = c('Similar',
               'Hotter & wetter',
               'Hotter & drier',
               'Colder & wetter',
               'Colder & drier',
               'Wetter & similar temp.',
               'Drier & similar temp.',
               'Hotter & similar ppt.',
               'Colder & similar ppt.'
               ),
    title ='Current climate conditions in WGEW:<br>Ppt.Range(mm)[320-440], Temp.Range(C)[14-18]'
  ) %>%
  addPolygons(
    fill=FALSE,color="red", weight=2, group="WGEW Extent") %>%
  addLayersControl(
    overlayGroups = c("WGEW Extent",
                     'Similar', 
                     'Hotter & wetter',
                     'Hotter & drier',
                     'Colder & wetter',
                     'Colder & drier',
                     'Wetter & similar temp.',
                     'Drier & similar temp.',
                     'Hotter & similar ppt.',
                     'Colder & similar ppt.'
                      ),
    #title = "Test",
    options = layersControlOptions(collapsed = FALSE))
 
 mapPast
```
<br>
<b>Figure 23.</b> Past conditions (1959-1979) compared to current conditions in WGEW (1980-2013).

<br>

```{r echo=FALSE, message=FALSE, warning=FALSE}

  r.pal.precip <- colorNumeric(c("#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c"), values(rsp), na.color="transparent")
  
 mapCurrentPrecip <- leaflet(wgew, width = "100%") %>% 
  addTiles("http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}") %>%
  addRasterImage(r.currentPrecip, colors = r.pal.precip, opacity=0.9, group ="Current Precip. 1980-2013") %>%
  addLegend(pal = r.pal.precip, values=values(rsp), opacity = 1, title = "Current Precip. (mm) <br> 1980-2013") %>%
  addPolygons(
    fill=FALSE,color="red", weight=2, group="WGEW Extent")
 
 mapCurrentPrecip
 
```
<br>
<b>Figure 23.</b> Current precipitation conditions (1980-2013).

<br>

```{r echo=FALSE, message=FALSE, warning=FALSE}
r.pal.temp <- colorNumeric(c("#ffffb2","#fecc5c","#fd8d3c","#f03b20","#bd0026"), values(r.currentTemp), na.color="transparent")
  
 mapCurrentTemp <- leaflet(wgew, width = "100%") %>% 
  addTiles("http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}") %>%
  addRasterImage(r.currentTemp, colors = r.pal.temp, opacity=0.9, group ="Current Temp. 1980-2013") %>%
  addLegend(pal = r.pal.temp, values=values(r.currentTemp), opacity = 1, title = "Current Temp. (C) <br> 1980-2013") %>%
  addPolygons(
    fill=FALSE,color="green", weight=2, group="WGEW Extent")
 
 mapCurrentTemp
 
```
<br>
<b>Figure 24.</b> Current temperature conditions (1980-2013).

<br>

```{r echo=FALSE, message=FALSE, warning=FALSE}
pal1<-colorNumeric(c("white", "#40E0D0"), c(0,1.5),na.color="transparent")
  pal2<-colorNumeric(c("white", "red"), c(0,1.5),na.color="transparent")
  pal3<-colorNumeric(c("white", "black"), c(0,1.5),na.color="transparent")
  pal4<-colorNumeric(c("white", "yellow"), c(0,1.5),na.color="transparent")
  pal5<-colorNumeric(c("white", "blue"), c(0,1.5),na.color="transparent")
  pal6<-colorNumeric(c("white", "#FF1493"), c(0,1.5),na.color="transparent")
  pal7<-colorNumeric(c("white", "#7CFC00"), c(0,1.5),na.color="transparent")
  pal8<-colorNumeric(c("white", "#DAA520"), c(0,1.5),na.color="transparent")
  pal9<-colorNumeric(c("white", "#8B4513"), c(0,1.5),na.color="transparent")

  
 mapCurrent<- leaflet(wgew, width = "100%") %>% 
  addTiles("http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}") %>%
  addRasterImage(current_similar_CC_to_ccWGEW, colors = pal1, opacity=0.7, group ="Similar") %>%
  addRasterImage(current_hotter_and_wetter_than_ccWGEW, colors = pal2, opacity=0.7, group ="Hotter & wetter") %>%
  addRasterImage(current_hotter_and_drier_than_ccWGEW, colors = pal3, opacity=0.7, group ="Hotter & drier") %>%
  addRasterImage(current_colder_and_wetter_than_ccWGEW, colors = pal4, opacity=0.7, group ="Colder & wetter") %>%
  addRasterImage(current_colder_and_Drier_than_ccWGEW, colors = pal5, opacity=0.7, group ="Colder & drier") %>%
  addRasterImage(current_wetter_and_similarTemp_to_ccWGEW, colors = pal6, opacity=0.7, group ="Wetter & similar temp.") %>%
  addRasterImage(current_drier_and_similarTemp_to_ccWGEW, colors = pal7, opacity=0.7, group ="Drier & similar temp.") %>%
  addRasterImage(current_hotter_and_similarPpt_to_ccWGEW, colors = pal8, opacity=0.7, group ="Hotter & similar ppt.") %>%
  addRasterImage(current_colder_and_similarPpt_to_ccWGEW, colors = pal9, opacity=0.7, group ="Colder & similar ppt.") %>%  
    
  
  
  addLegend(
    position='bottomright',
    colors = c("#40E0D0","red", "black","yellow","blue","#FF1493","#7CFC00","#DAA520","#8B4513"),
    labels = c('Similar',
               'Hotter & wetter',
               'Hotter & drier',
               'Colder & wetter',
               'Colder & drier',
               'Wetter & similar temp.',
               'Drier & similar temp.',
               'Hotter & similar ppt.',
               'Colder & similar ppt.'
               ),
    title ='Current climate conditions in WGEW:<br>Ppt.Range(mm)[320-440], Temp.Range(C)[14-18]'
  ) %>%
  addPolygons(
    fill=FALSE,color="red", weight=2, group="WGEW Extent") %>%
  addLayersControl(
    overlayGroups = c("WGEW Extent",
                     'Similar', 
                     'Hotter & wetter',
                     'Hotter & drier',
                     'Colder & wetter',
                     'Colder & drier',
                     'Wetter & similar temp.',
                     'Drier & similar temp.',
                     'Hotter & similar ppt.',
                     'Colder & similar ppt.'
                      ),
    #title = "Test",
    options = layersControlOptions(collapsed = FALSE))
 
 mapCurrent

```
<br>
<b> Figure 26.</b> Spatial comparison of WGEW with the surrounding areas at current conditions (1980-2013).

<br>

```{r echo=FALSE, message=FALSE, warning=FALSE}

  r.pal.precip <- colorNumeric(c("#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c"), values(rsp), na.color="transparent")
mapFuturePrecip <- leaflet(wgew, width = "100%") %>% 
  addTiles("http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}") %>%
  addRasterImage(r.futurePrecip, colors = r.pal.precip, opacity=0.9, group ="Future Precip. 2013-2044") %>%
  addLegend(pal = r.pal.precip, values=values(rsp), opacity = 1, title = "Future Precip. (mm) <br> 2014-2044") %>%
  addPolygons(
    fill=FALSE,color="red", weight=2, group="WGEW Extent")

mapFuturePrecip

```
<br>
<b>Figure 27.</b> This is a grid with average future precipitation based on the IPCC RCP26 data.  

<br>

```{r echo=FALSE, message=FALSE, warning=FALSE}

 
  r.pal.temp <- colorNumeric(c("#ffffb2","#fecc5c","#fd8d3c","#f03b20","#bd0026"), values(r.futureTemp), na.color="transparent")
  
 mapFutureTemp <- leaflet(wgew, width = "100%") %>% 
  addTiles("http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}") %>%
  addRasterImage(r.futureTemp, colors = r.pal.temp, opacity=0.9, group ="Future Temp. 1980-2013") %>%
  addLegend(pal = r.pal.temp, values=values(r.futureTemp), opacity = 1, title = "Future Temp. (C) <br> 1980-2013") %>%
  addPolygons(
    fill=FALSE,color="green", weight=2, group="WGEW Extent")

 mapFutureTemp
```
<br>
<b>Figure 28.</b> Grid with projected future temperatures based on IPCC data (2014-2044).

<br>

```{r echo=FALSE, message=FALSE, warning=FALSE}

  pal1<-colorNumeric(c("white", "#40E0D0"), c(0,1.5),na.color="transparent")
  pal2<-colorNumeric(c("white", "red"), c(0,1.5),na.color="transparent")
  pal3<-colorNumeric(c("white", "black"), c(0,1.5),na.color="transparent")
  pal4<-colorNumeric(c("white", "yellow"), c(0,1.5),na.color="transparent")
  pal5<-colorNumeric(c("white", "blue"), c(0,1.5),na.color="transparent")
  pal6<-colorNumeric(c("white", "#FF1493"), c(0,1.5),na.color="transparent")
  pal7<-colorNumeric(c("white", "#7CFC00"), c(0,1.5),na.color="transparent")
  pal8<-colorNumeric(c("white", "#DAA520"), c(0,1.5),na.color="transparent")
  pal9<-colorNumeric(c("white", "#8B4513"), c(0,1.5),na.color="transparent")

mapFuture<- leaflet(wgew, width = "100%") %>% 
  addTiles("http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}") %>%
  addRasterImage(future_similar_CC_to_ccWGEW, colors = pal1, opacity=0.7, group ="Similar") %>%
  addRasterImage(future_hotter_and_wetter_than_ccWGEW, colors = pal2, opacity=0.7, group ="Hotter & wetter") %>%
  addRasterImage(future_hotter_and_drier_than_ccWGEW, colors = pal3, opacity=0.7, group ="Hotter & drier") %>%
  addRasterImage(future_colder_and_wetter_than_ccWGEW, colors = pal4, opacity=0.7, group ="Colder & wetter") %>%
  addRasterImage(future_colder_and_Drier_than_ccWGEW, colors = pal5, opacity=0.7, group ="Colder & drier") %>%
  addRasterImage(future_wetter_and_similarTemp_to_ccWGEW, colors = pal6, opacity=0.7, group ="Wetter & similar temp.") %>%
  addRasterImage(future_drier_and_similarTemp_to_ccWGEW, colors = pal7, opacity=0.7, group ="Drier & similar temp.") %>%
  addRasterImage(future_hotter_and_similarPpt_to_ccWGEW, colors = pal8, opacity=0.7, group ="Hotter & similar ppt.") %>%
  addRasterImage(future_colder_and_similarPpt_to_ccWGEW, colors = pal9, opacity=0.7, group ="Colder & similar ppt.") %>%  

  addLegend(
    position='bottomright',
    colors = c("#40E0D0","red", "black","yellow","blue","#FF1493","#7CFC00","#DAA520","#8B4513"),
    labels = c('Similar',
               'Hotter & wetter',
               'Hotter & drier',
               'Colder & wetter',
               'Colder & drier',
               'Wetter & similar temp.',
               'Drier & similar temp.',
               'Hotter & similar ppt.',
               'Colder & similar ppt.'
               ),
    title ='Current climate conditions in WGEW:<br>Ppt.Range(mm)[320-440], Temp.Range(C)[14-18]'
  ) %>%
  addPolygons(
    fill=FALSE,color="red", weight=2, group="WGEW Extent") %>%
  addLayersControl(
    overlayGroups = c("WGEW Extent",
                     'Similar', 
                     'Hotter & wetter',
                     'Hotter & drier',
                     'Colder & wetter',
                     'Colder & drier',
                     'Wetter & similar temp.',
                     'Drier & similar temp.',
                     'Hotter & similar ppt.',
                     'Colder & similar ppt.'
                      ),
    #title = "Test",
    options = layersControlOptions(collapsed = FALSE))
 
mapFuture 

```
<br>
<b>Figure 29.</b> Spatial comparison between future climate conditions around WGEW versus current conditions at WGEW. 

